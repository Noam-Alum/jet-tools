#!/bin/bash
### Naknik function V2

## GET VARS

# domain name
domainname="$1"
while [ -z "$domainname" ]
do
	echo -e "\033[1;92mCorrect usage:\033[0m"" curl -Ls 'ncode.codes/NF'|bash -s https://yourdomain.com"
done

# if not a url make it a url
if [ -z "$(echo $domainname | grep http)" ]; then
	domainname="https://$domainname"
fi

## functions
function activate_plugins {
    for ((i=0; i<$NUM; i++)); do
        wp plugin activate "${FILE[i]}" --allow-root &> /dev/null
    done
}

function get_result {
    local error_code="$1"
    shift
    local error_exp="$*"

	if [ "$RES" = "$error_code" ]; then
		echo -e "• ERROR: ""\033[1;31m$error_code\033[0m" 
		echo "• $error_exp."
		activate_plugins
		return
	fi
}

## START SCRIPT

# check for website root directory
if [ -z "$(find . -type d -name wp-content)" ]; then
        echo -e "ERROR: ""\033[1;31mWordpress installation was not detected.\033[0m"
		exit 1
fi

function NAKNIK() {
# check for error 500
echo -e "
    _   _____    __ __ _   ________ __            
   / | / /   |  / //_// | / /  _/ //_/            
  /  |/ / /| | / ,<  /  |/ // // ,<               
 / /|  / ___ |/ /| |/ /|  // // /| |              
/_/ |_/_/__|_/_/_|_/_/_|_/___/_/_|_|______  _   __
   / ____/ / / / | / / ____/_  __/  _/ __ \/ | / /
  / /_  / / / /  |/ / /     / /  / // / / /  |/ / 
 / __/ / /_/ / /|  / /___  / / _/ // /_/ / /|  /  
/_/    \____/_/ |_/\____/ /_/ /___/\____/_/ |_/   
                                                  
"
FILE=( $(wp plugin list --allow-root --status=active | awk -F 'active' '{print $1}' | tail -n +2) )
NUM=${#FILE[@]}
	
echo "Problematic plugins:"
echo ""

# check if webste is ok
if [ "$(curl -LsI -m 3 "$domainname" | grep "HTTP/" | tail -n 1 | awk {'print $2'})" == "200" ]; then
	echo -e "• WEBSITE IS OK.
	"
	exit 0
fi
			mv wp-content/plugins wp-content/plugins_hold
		    for ((i=0; i<$NUM; i++)); do
		        wp plugin deactivate "${FILE[i]}" --allow-root &> /dev/null
		    done
		    RESULT=$(
			for ((i=0; i<$NUM; i++)); do
		        wp plugin activate "${FILE[i]}" --allow-root &> /dev/null
		        RES=$(curl -LsI -m 3 "$domainname" | grep "HTTP/" | tail -n 1 | awk {'print $2'})
			if [ "$RES" = "500" ]; then
		        	 wp plugin deactivate "${FILE[i]}" --allow-root &> /dev/null
			         paste <(echo "$i. ""$RES" "${FILE[i]}" | sed s#'/'#' '#g | awk {'print $1, $2, $NF'} | grep -v '200') <(echo -e "\033[1;31mWAS SHUT DOWN\033[0m")
			fi
			
			# Couldn't resolve
			if [ -z "$RES" ]; then
				echo -e "• ERROR: ""\033[1;31mCouldn't resolve host \"$domainname\"\033[0m"
                echo ""
                activate_plugins
                return
			fi

			# 400 - Bad Request
			get_result 400 "The server could not understand the request on \"$domainname\". It may be malformed or missing required data."

			# 401 - Unauthorized
			get_result 401 "Access to \"$domainname\" is unauthorized. Please provide valid credentials to access this resource."

			# 403 - Forbidden
			get_result 403 "Access to \"$domainname\" is forbidden. You do not have permission to view this resource."

			# 404 - Not Found
			get_result 404 "The server could not find the requested resource on \"$domainname\"."

			# 405 - Method Not Allowed
			get_result 405 "The request method is not allowed on \"$domainname\". Please check the HTTP method used."

			# 408 - Request Timeout
			get_result 408 "The request to \"$domainname\" has timed out. Please try again."

			# 502 - Bad Gateway
			get_result 502 "The server acting as a gateway received an invalid response from the upstream server for \"$domainname\"."

			# 503 - Service Unavailable
			get_result 503 "The service on \"$domainname\" is temporarily unavailable. Please try again later."

			# 504 - Gateway Timeout
			get_result 504 "The gateway server timed out while waiting for a response from the upstream server for \"$domainname\"."

			# 301 - Moved Permanently
			get_result 301 "The requested resource has been permanently moved to a new location on \"$domainname\"."

			# 302 - Found (Temporary Redirect)
			get_result 302 "The requested resource has been temporarily moved to a different location on \"$domainname\"."

			# 307 - Temporary Redirect
			get_result 307 "The requested resource has been temporarily moved to a different location on \"$domainname\"."

			# 401 - Payment Required
			get_result 402 "Payment is required to access \"$domainname\". Please make the required payment."

			# 429 - Too Many Requests
			get_result 429 "The rate limit for accessing \"$domainname\" has been exceeded. Please wait and try again."

			# 503 - Service Unavailable
			get_result 503 "The service on \"$domainname\" is overloaded or undergoing maintenance. Please try again later."

			# 504 - Gateway Timeout
			get_result 504 "The gateway server timed out while waiting for a response from the upstream server for \"$domainname\"."

			# 511 - Network Authentication Required
			get_result 511 "Network authentication is required to access \"$domainname\". Please provide valid network credentials."

			# 418 - I'm a teapot (RFC 2324)
			get_result 418 "The server refuses to brew coffee because it is, permanently, a teapot."

			done
			#mv wp-content/plugins_hold wp-content/plugins
		    )
		    echo "$RESULT"
		    echo ""
		}

NAKNIK
RES=$(curl -sLI -m 3 "$domainname" | grep -i -m1 HTTP/ | tail -n 1)
 if [ "$RES" = "200" ]; then
	echo "Result:"
	echo ""
	echo -e "• STATUS CODE: ""\033[1;92m200\033[0m"
	echo "• Request has succeeded, it seems that the website "$domainname" is functioning properly."		
	echo ""
fi
